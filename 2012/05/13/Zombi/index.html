<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Bővített kiadás"><title>Zombiföldről - visszafejtve | Caiwan Blogja</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Caiwan Blogja</a><span class="subtitle">Farkaska kalajdnai az IT világában</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Zombiföldről - visszafejtve</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2012-05-13</div><div class="post-categories"><a class="post-category-link" href="/categories/prog/">prog</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/assembly/">assembly</a>/<a class="post-tag-link" href="/tags/bme/">bme</a>/<a class="post-tag-link" href="/tags/c64/">c64</a>/<a class="post-tag-link" href="/tags/disassembly/">disassembly</a></div></div></div><article><div class="container post"><p>Egy ismerősömtől kaptam egy levelet, hogy segítsek egy BME-VIK gólyatábor feladat megoldásában, mivel korábban többször foglalkoztam Commodore 64 programozással, és érdekelt, hogy a VIK-es kollégák milyen programot írtak C64-re, ezért teljesen visszafejtettem a kiadott programot.</p>
<p>A történet szerint zombik ellen kell harcolnunk, és szükségrogünk van egy titkos kódra.  A  program a képernyő felső sorába egy scroller van, amiben a küldetés  feladatait sorolja, alsó sorban pedig egy sprite, amin a titkos kód  található, amit a keret eltakar. Ránézésre egyszerű kis programocska, de  nézzünk bele, mi is van benne pontosan, és milyen megoldásokat  alkalmaztak.</p>
<p><strike>Forrás: </strike><a href="http://golya.sch.bme.hu/rejtvenyek_zombifoldrol_2____commodore" style="text-decoration: line-through;" target="_blank" rel="external">http://golya.sch.bme.hu/rejtvenyek_zombifoldrol_2____commodore</a> <b>Már nem elérhető az eredeti helyen.</b></p>
<h2 id="Kezdo-lepesek"><a href="#Kezdo-lepesek" class="headerlink" title="Kezdő lépések"></a>Kezdő lépések</h2><p>Akkor lássunk is neki, ezúttal modern eszközök felhasználásával. A boncoláshoz a Vice monitorját használom fel, illetve az ICU64 nevű progit, ami láthatóvá teszi valós időben a gép memóriáját. </p>
<p>Először illene tudni, hogy a program a memória melyik területén helyezkedik majd el, a betöltést követően. Ezt nem nehéz megmondani. Minden C64 futtatható bináris első két byteja a kezdőcímet tartalmazza, ahova betölti a lemezről Kernal (nem <em>kernel</em> ) a kódot. Mivel programunk a <code>RUN</code> parancsra le is fut, ezért ennek a címnek a basic terület elejére kell hogy mutasson, ami a <code>$0800</code> = 2048 (továbbiakban <code>$xxxx</code> formátumban írom le) címtől kezdődik. Ha ezen a címen <code>$00</code> van, akkor a Kernal az ezt követő kódot basic kódként fogja kezelni, tehát a fileunk a <code>$0801</code> címtől kell hogy betöltődjön, de azért nézzünk bele egy HEX editorral:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">0000: 01 08</span><br></pre></td></tr></table></figure>
<p>így is van. A fileunkból ez a két byte “kiesik” így a 2048 byteos hossz 2046-ra (<code>$03FE</code>) csökken. A kezdőcímből és a hosszból tudjuk, hogy a kódunk <code>$0801</code> és <code>$0BFF</code> között lesz (A továbbiakban a listázást mégis <code>$0800</code>-ról kezdem majd)</p>
<p>Minden program, amit <code>RUN</code> paranccsal szeretnénk futtatni, annak a basic tárterület elejétől a basic interpreter által értelmezhető basic kódnak kell lennie. Még akkor is, ha a basicben egyetlen <code>SYS</code> parancs található, amivel a megadott címtől kezdődő gépi kód hajtódik végre. Ebből következik, hogy a <code>LIST</code> parancs kiadására, látni kellene valamilyen basic kódot.</p>
<div class="separator" style="clear: both; text-align: center;"><br><a href="http://4.bp.blogspot.com/-voW38pa27TM/Tjv7jOkNB8I/AAAAAAAABiU/Zdtp9swcRv4/s1600/Clipboard-4.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" target="_blank" rel="external"><img border="0" height="283" src="http://4.bp.blogspot.com/-voW38pa27TM/Tjv7jOkNB8I/AAAAAAAABiU/Zdtp9swcRv4/s400/Clipboard-4.jpg" width="400"></a></div>

<p>Hopp, nem így történt. VIK-es kollégáink valamilyen listázás elleni védelmet alkalmaztak, vagy azért hogy jobban nézzen ki a lista, vagy azért, hogy elrejtsék a gépi kód kezdőcímét. Akkor nézzünk bele a BASIC ram területbe, mi található ott.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">&gt;C:0800  00 1e 08 00  00 9e 32 34   ......24</span><br><span class="line">&gt;C:0808  37 34 3a 8f  22 8d 91 2d   74:.&quot;..-</span><br><span class="line">&gt;C:0810  42 4d 45 2d  56 49 4b 20   BME-VIK</span><br><span class="line">&gt;C:0818  32 30 31 31  2d 00 00 00   2011-...</span><br></pre></td></tr></table></figure>
<p>Nos, lássuk hogy is kell mindezt értelmezni, ezúttal $0800-tól:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line">0800: 00           Basic fejléc</span><br><span class="line">0801: 1e 08        Következo sor kezdocíme (link)</span><br><span class="line">0803: 00 00        Sorszám (16 biten)</span><br><span class="line">0805: 9e           Basic token</span><br><span class="line">0806: 32 34 37 34  Basic utasítás argumentumai (ascii-ba)  </span><br><span class="line">080a: 3a           A basic utasításokat elválasztó kettospont </span><br><span class="line">080b: 8f           Következo basic token </span><br><span class="line">080c: 22 8d 91 ... Argumentumok </span><br><span class="line">081d: 00           Sor vége </span><br><span class="line">081e: 00 00        Következo sor kezdocíme</span><br></pre></td></tr></table></figure>
<p>Vegyük szépen sorba. A sorok egy láncolt listához hasonló (de nem teljesen az, mert köztes sor beszúrásakor átrendezi) struktúrában foglalnak helyet; illetve csak listázáskor használja az interpreter.  A linket követően a sorszám, majd a sor tartalma. Minden sor végét egy nulla jelöl. Minden basic utasítást rövidít le.</p>
<p>Ezek alapján a basic sorunk valahogy így fest:</p>
<div class="separator" style="clear: both; text-align: center;"><br><a href="http://4.bp.blogspot.com/-XDxIB_M10jM/T6LEcyXpmuI/AAAAAAAAB8Y/6pEOQ2xhUPs/s1600/Clipboard-3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" target="_blank" rel="external"><img border="0" height="15" src="http://4.bp.blogspot.com/-XDxIB_M10jM/T6LEcyXpmuI/AAAAAAAAB8Y/6pEOQ2xhUPs/s640/Clipboard-3.png" width="640"></a></div>

<p>Itt látható már, hogy a basic kódba a megjegyzés utasítást (REM) követő három karakter felel a “védelemért”, az inverz M és Q két vezérlőkarakter (CBM karaktertábla szerint). Ezek a vezérlő karakterek ún. idézőjel-módba karakterláncként építhetők be a kódba, későbbi felhasználás (print) végett. Ha ebből a módból sikerül “megszökni”, akkor a list parancs kírás közbe “végrehajtja” ezeket. Az inverz M sortörést produkál, az inverz Q pedig egy kurzor fel, így a <code>-BME-VIK-2011-</code> karaktersor felülírja listázáskor az előzőleg kiírt <code>0 sys2474:REM&quot;</code> részt.</p>
<p>Ezután már a kezdőcímet követve végig kell menni egy disassemberrel a memóraképen. Vice-ban van beépített monitor, ami képes mindenféle mellékhatás nélkül a memóriába látni.</p>
<h3 id="Teljes-disassembly"><a href="#Teljes-disassembly" class="headerlink" title="Teljes disassembly"></a>Teljes disassembly</h3><p>Végül itt a teljes disassemblelt kód:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br></pre></td><td class="code"><pre><span class="line">; BME-VIK gólyafeladat</span><br><span class="line">; FULL DISASSEMBLY</span><br><span class="line"></span><br><span class="line">                                    ; BASIC LOADER</span><br><span class="line"></span><br><span class="line">&gt;C:0800  00 1e 08 00  00 9e 32 34   ......24</span><br><span class="line">&gt;C:0808  37 34 3a 8f  22 8d 91 2d   74:.&quot;..-</span><br><span class="line">&gt;C:0810  42 4d 45 2d  56 49 4b 20   BME-VIK</span><br><span class="line">&gt;C:0818  32 30 31 31  2d 00 00 00   2011-...</span><br><span class="line"></span><br><span class="line">                                    ; entry point (2474 = $09aa)</span><br><span class="line">                                    ; MAIN</span><br><span class="line">                                    </span><br><span class="line">.C:09aa   20 63 0B   JSR $0B63      ; call subroutine 1</span><br><span class="line">.C:09ad   20 FD 0A   JSR $0AFD      ; call subroutine 2</span><br><span class="line">.C:09b0   60         RTS            ; return (to basic)</span><br><span class="line"></span><br><span class="line">                                    ; IRQ routine</span><br><span class="line">                                    </span><br><span class="line">.C:09b1   20 C2 09   JSR $09C2      ; call scroller subroutine </span><br><span class="line"></span><br><span class="line">.C:09b4   EE 00 D0   INC $D000      ; increase sprite #0 X coord (#bit 0-7)</span><br><span class="line">.C:09b7   D0 03      BNE $09BC      ; branch while overflow occurs via INC</span><br><span class="line">.C:09b9   EE 10 D0   INC $D010      ; increase sprite #bit 8</span><br><span class="line"></span><br><span class="line">.C:09bc   0E 19 D0   ASL $D019      ; acknowledge raster IRQ</span><br><span class="line">.C:09bf   4C 31 EA   JMP $EA31      ; jump back to kernal</span><br><span class="line"></span><br><span class="line">                                    ; scroller</span><br><span class="line">                                    </span><br><span class="line">.C:09c2   8D F5 09   STA $09F5      ; push X, Y regs and A to local vars (@ line $09f4)</span><br><span class="line">.C:09c5   8E F7 09   STX $09F7    </span><br><span class="line">.C:09c8   8C F9 09   STY $09F9      </span><br><span class="line"></span><br><span class="line">.C:09cb   AE FB 09   LDX $09FB      ; inc local var 1 @09FB - delay</span><br><span class="line">.C:09ce   E8         INX</span><br><span class="line">.C:09cf   8E FB 09   STX $09FB</span><br><span class="line">.C:09d2   E0 08      CPX #$08        </span><br><span class="line">.C:09d4   D0 1E      BNE $09F4      ; if (X != 8) branch</span><br><span class="line"></span><br><span class="line">.C:09d6   A2 00      LDX #$00</span><br><span class="line">.C:09d8   8E FB 09   STX $09FB      ; local var 1</span><br><span class="line">.C:09db   A0 00      LDY #$00</span><br><span class="line">.C:09dd   AE FC 09   LDX $09FC      ; local var 2 - text pointer</span><br><span class="line">.C:09e0   BD FD 09   LDA $09FD,X    ; text data</span><br><span class="line">.C:09e3   E8         INX</span><br><span class="line">.C:09e4   99 00 04   STA $0400,Y    ; copy to screen</span><br><span class="line">.C:09e7   A9 01      LDA #$01       ; fill color memory</span><br><span class="line">.C:09e9   99 00 D8   STA $D800,Y    </span><br><span class="line">.C:09ec   C8         INY</span><br><span class="line">.C:09ed   C0 28      CPY #$28</span><br><span class="line">.C:09ef   D0 EF      BNE $09E0      ; loop while (y != 40)</span><br><span class="line">.C:09f1   EE FC 09   INC $09FC      ; inc text pointer</span><br><span class="line"></span><br><span class="line">.C:09f4   A9 00      LDA #$00       ; pop X, Y regs and A from local vars (set @ line $09c2)</span><br><span class="line">.C:09f6   A2 00      LDX #$00</span><br><span class="line">.C:09f8   A0 00      LDY #$00</span><br><span class="line"></span><br><span class="line">.C:09fa   60         RTS            ; return</span><br><span class="line"></span><br><span class="line">                                    ; local vars ($09fb-$09fc) + scroller text</span><br><span class="line">&gt;C:09fb  00 00 20 20  20 20 20 20   ..        ;   &quot;      &quot;</span><br><span class="line">&gt;C:0a03  20 20 20 20  20 20 20 20             ; &quot;        &quot;</span><br><span class="line">&gt;C:0a0b  20 20 20 20  20 20 20 20             ; &quot;        &quot;</span><br><span class="line">&gt;C:0a13  20 20 20 20  20 20 20 20             ; &quot;        &quot;</span><br><span class="line">&gt;C:0a1b  20 20 20 20  20 20 20 20             ; &quot;        &quot;</span><br><span class="line">&gt;C:0a23  20 20 01 0e  14 09 2d 1a     ....-.  ; &quot;  ANTI-Z&quot;</span><br><span class="line">&gt;C:0a2b  0f 0d 02 09  05 20 02 15   ..... ..  ; &quot;OMBIE BU&quot;</span><br><span class="line">&gt;C:0a33  0e 0b 05 12  20 03 0f 0d   .... ...  ; &quot;NKER COM&quot;</span><br><span class="line">&gt;C:0a3b  0d 01 0e 04  20 01 13 13   .... ...  ; &quot;MAND ASS&quot;</span><br><span class="line">&gt;C:0a43  09 07 0e 0d  05 0e 14 3a   .......:  ; &quot;IGNMENT:&quot;</span><br><span class="line">&gt;C:0a4b  20 20 20 31  2e 20 05 12      1. ..  ; &quot;   1. ER&quot;</span><br><span class="line">&gt;C:0a53  01 04 09 03  01 14 05 20   .......   ; &quot;DANCIATE&quot;</span><br><span class="line">&gt;C:0a5b  01 0e 19 20  01 0e 04 20   ... ...   ; &quot;ANY AND &quot;</span><br><span class="line">&gt;C:0a63  01 0c 0c 20  08 0f 13 14   ... ....  ; &quot;ALL HOST&quot;</span><br><span class="line">&gt;C:0a6b  09 0c 05 20  06 0f 12 03   ... ....  ; &quot;ILE FORC&quot;</span><br><span class="line">&gt;C:0a73  05 13 2e 20  20 32 2e 20   ...  2.   ; &quot;ES.  2. &quot;</span><br><span class="line">&gt;C:0a7b  12 05 03 0f  16 05 12 20   .......   ; &quot;RECOVER &quot;</span><br><span class="line">&gt;C:0a83  01 0c 0c 20  01 16 01 09   ... ....  ; &quot;ALL AVAI&quot;</span><br><span class="line">&gt;C:0a8b  0c 01 02 0c  05 20 13 15   ..... ..  ; &quot;LABLE SU&quot;</span><br><span class="line">&gt;C:0a93  10 10 0c 09  05 13 2e 20   .......   ; &quot;PPLIES. &quot;</span><br><span class="line">&gt;C:0a9b  20 20 33 2e  20 03 0f 0d     3. ...  ; &quot;  3. COM&quot;</span><br><span class="line">&gt;C:0aa3  10 0c 05 14  05 20 13 05   ..... ..  ; &quot;PLETE SE&quot;</span><br><span class="line">&gt;C:0aab  03 12 05 14  20 0d 09 13   .... ...  ; &quot;CRET MIS&quot;</span><br><span class="line">&gt;C:0ab3  13 09 0f 0e  2e 20 20 34   .....  4  ; &quot;SION.  4&quot;</span><br><span class="line">&gt;C:0abb  2e 20 13 14  01 19 20 01   . .... .  ; &quot;. STAY A&quot;</span><br><span class="line">&gt;C:0ac3  0c 09 16 05  2c 20 12 05   ...., ..  ; &quot;LIVE, RE&quot;</span><br><span class="line">&gt;C:0acb  10 0f 12 14  20 02 01 03   .... ...  ; &quot;PORT BAC&quot;</span><br><span class="line">&gt;C:0ad3  0b 20 14 0f  20 02 01 13   . .. ...  ; &quot;K TO BAS&quot;</span><br><span class="line">&gt;C:0adb  05 20 01 0e  04 20 04 0f   . ... ..  ; &quot;E AND DO&quot;</span><br><span class="line">&gt;C:0ae3  0e 27 14 20  07 05 14 20   .&apos;. ...   ; &quot;N&apos;T GET &quot;</span><br><span class="line">&gt;C:0aeb  08 15 12 14  21 20 20 20   ....!     ; &quot;HURT!   &quot;</span><br><span class="line">&gt;C:0af3  07 0f 0f 04  20 0c 15 03   .... ...  ; &quot;GOOD LUC&quot;</span><br><span class="line">&gt;C:0afb  0b 21                      .!        ; &quot;K!&quot;</span><br><span class="line"></span><br><span class="line">                                    ; SUBROUTINE 2</span><br><span class="line">                                    ; interruption setup</span><br><span class="line">                                    </span><br><span class="line">.C:0afd   78         SEI            ; set interrupt bit</span><br><span class="line"></span><br><span class="line">.C:0afe   A9 7F      LDA #$7F       ; Set interrupt controls</span><br><span class="line">.C:0b00   8D 0D DC   STA $DC0D      ; Set IRQ </span><br><span class="line">.C:0b03   8D 0D DD   STA $DD0D      ; Set NMI (WTF)</span><br><span class="line">.C:0b06   AD 1A D0   LDA $D01A      ; Enable raster interruption</span><br><span class="line">.C:0b09   09 01      ORA #$01       ; bitmask 000001</span><br><span class="line">.C:0b0b   8D 1A D0   STA $D01A      </span><br><span class="line">.C:0b0e   AD 11 D0   LDA $D011      ; Rasterline to generate interruption</span><br><span class="line">.C:0b11   29 7F      AND #$7F       ; bitmask %01111111</span><br><span class="line">.C:0b13   8D 11 D0   STA $D011      </span><br><span class="line">.C:0b16   A9 01      LDA #$01       ; Set the interruption on raster line $01</span><br><span class="line">.C:0b18   8D 12 D0   STA $D012</span><br><span class="line">.C:0b1b   A9 B1      LDA #$B1       ; Set IRQ vector (lo)</span><br><span class="line">.C:0b1d   8D 14 03   STA $0314</span><br><span class="line">.C:0b20   A9 09      LDA #$09       ; (hi)</span><br><span class="line">.C:0b22   8D 15 03   STA $0315      ; IRQ at $09B1</span><br><span class="line"></span><br><span class="line">.C:0b25   58         CLI            ; clear interrupt bit</span><br><span class="line">.C:0b26   60         RTS            ; return</span><br><span class="line"></span><br><span class="line">                                    ; SUBROUTINE 3 - memcpy</span><br><span class="line"></span><br><span class="line">.C:0b27   8C 44 0B   STY $0B44      ; set comparison val @ line $0b43 to Y reg.</span><br><span class="line"></span><br><span class="line">.C:0b2a   A0 00      LDY #$00       ; clear Y</span><br><span class="line">.C:0b2c   E0 00      CPX #$00</span><br><span class="line">.C:0b2e   F0 0E      BEQ $0B3E      ; if (X == 0) branch</span><br><span class="line"></span><br><span class="line">.C:0b30   B1 FB      LDA ($FB),Y    ; copy ($FB)+y to ($FD)+y</span><br><span class="line">.C:0b32   91 FD      STA ($FD),Y</span><br><span class="line">.C:0b34   C8         INY            ; inc Y</span><br><span class="line">.C:0b35   D0 F9      BNE $0B30      ; loop</span><br><span class="line"></span><br><span class="line">.C:0b37   E6 FE      INC $FE        ; inc $FE (hi byte of src)</span><br><span class="line">.C:0b39   E6 FC      INC $FC        ; inc $FC (hi byte of dest)</span><br><span class="line">.C:0b3b   CA         DEX            ; dec X</span><br><span class="line">.C:0b3c   D0 F2      BNE $0B30      ; loop while (X != 0)</span><br><span class="line"></span><br><span class="line">.C:0b3e   B1 FB      LDA ($FB),Y    ; copy ($FB)+y to ($FD)+y</span><br><span class="line">.C:0b40   91 FD      STA ($FD),Y</span><br><span class="line">.C:0b42   C8         INY</span><br><span class="line"></span><br><span class="line">.C:0b43   C0 00      CPY #$00       ; compare (were set @ line $0b27)</span><br><span class="line">.C:0b45   D0 F7      BNE $0B3E      ; loop</span><br><span class="line"></span><br><span class="line">.C:0b47   60         RTS            ; return </span><br><span class="line"></span><br><span class="line">                                    ; SUBROUTINE 4 - memset</span><br><span class="line">                                    </span><br><span class="line">.C:0b48   8C 5F 0B   STY $0B5F      ; set cmp. val @ line $0b5e</span><br><span class="line"></span><br><span class="line">.C:0b4b   A0 00      LDY #$00</span><br><span class="line">.C:0b4d   E0 00      CPX #$00</span><br><span class="line">.C:0b4f   F0 0A      BEQ $0B5B      ; if (X == 0) branch</span><br><span class="line"></span><br><span class="line">.C:0b51   91 FD      STA ($FD),Y    ; set ($FD)+y to ACC</span><br><span class="line">.C:0b53   C8         INY</span><br><span class="line">.C:0b54   D0 FB      BNE $0B51      ; loop</span><br><span class="line"></span><br><span class="line">.C:0b56   E6 FE      INC $FE        ; inc $FE (hi byte of dst)</span><br><span class="line">.C:0b58   CA         DEX</span><br><span class="line">.C:0b59   D0 F6      BNE $0B51      ; loop</span><br><span class="line"></span><br><span class="line">.C:0b5b   91 FD      STA ($FD),Y</span><br><span class="line">.C:0b5d   C8         INY</span><br><span class="line">.C:0b5e   C0 00      CPY #$00</span><br><span class="line">.C:0b60   D0 F9      BNE $0B5B      ; loop</span><br><span class="line"></span><br><span class="line">.C:0b62   60         RTS            ; return</span><br><span class="line">        </span><br><span class="line">                                    ; SUBROUTINE 1 </span><br><span class="line"></span><br><span class="line">.C:0b63   A9 01      LDA #$01       ; set sprite #0 X-coord #bit 8</span><br><span class="line">.C:0b65   8D 10 D0   STA $D010</span><br><span class="line"></span><br><span class="line">.C:0b68   A9 00      LDA #$00</span><br><span class="line">.C:0b6a   8D 17 D0   STA $D017      ; reset sprite double height bits</span><br><span class="line">.C:0b6d   8D 1B D0   STA $D01B      ; reset sprite priority bits </span><br><span class="line">.C:0b70   8D 1C D0   STA $D01C      ; reset sprite multicolor bits</span><br><span class="line">.C:0b73   8D 1D D0   STA $D01D      ; reset sprite double bits</span><br><span class="line"></span><br><span class="line">.C:0b76   A9 60      LDA #$60       ; set sprite #0 X-coord</span><br><span class="line">.C:0b78   8D 00 D0   STA $D000</span><br><span class="line">.C:0b7b   A9 EE      LDA #$EE       ; set sprite #0 Y-coord</span><br><span class="line">.C:0b7d   8D 01 D0   STA $D001</span><br><span class="line"></span><br><span class="line">.C:0b80   A9 01      LDA #$01       ; set sprite #0 color</span><br><span class="line">.C:0b82   8D 27 D0   STA $D027        </span><br><span class="line"></span><br><span class="line">.C:0b85   A9 FF      LDA #$FF       ; set sprite data pointer</span><br><span class="line">.C:0b87   8D F8 07   STA $07F8</span><br><span class="line"></span><br><span class="line">.C:0b8a   A5 FB      LDA $FB        ; push zero page to stack</span><br><span class="line">.C:0b8c   48         PHA</span><br><span class="line">.C:0b8d   A5 FC      LDA $FC</span><br><span class="line">.C:0b8f   48         PHA</span><br><span class="line">.C:0b90   A5 FD      LDA $FD</span><br><span class="line">.C:0b92   48         PHA</span><br><span class="line">.C:0b93   A5 FE      LDA $FE</span><br><span class="line">.C:0b95   48         PHA</span><br><span class="line"></span><br><span class="line">.C:0b96   A9 BF      LDA #$BF       ; copy source (lo)</span><br><span class="line">.C:0b98   85 FB      STA $FB</span><br><span class="line">.C:0b9a   A9 0B      LDA #$0B       ; copy source (hi) - sprite data $0bbf</span><br><span class="line">.C:0b9c   85 FC      STA $FC</span><br><span class="line">.C:0b9e   A9 C0      LDA #$C0       ; copy dest. (lo)</span><br><span class="line">.C:0ba0   85 FD      STA $FD</span><br><span class="line">.C:0ba2   A9 3F      LDA #$3F       ; copy dest. (hi) - sprite data $3fc0 </span><br><span class="line">.C:0ba4   85 FE      STA $FE</span><br><span class="line">.C:0ba6   A4 3F      LDY $3F        ; legth (lo)</span><br><span class="line">.C:0ba8   A6 40      LDX $40        ; legth (hi)</span><br><span class="line">.C:0baa   20 27 0B   JSR $0B27      ; call subroutine 3</span><br><span class="line"></span><br><span class="line">.C:0bad   68         PLA            ; pop zero page from stack</span><br><span class="line">.C:0bae   85 FE      STA $FE</span><br><span class="line">.C:0bb0   68         PLA</span><br><span class="line">.C:0bb1   85 FD      STA $FD</span><br><span class="line">.C:0bb3   68         PLA</span><br><span class="line">.C:0bb4   85 FC      STA $FC</span><br><span class="line">.C:0bb6   68         PLA</span><br><span class="line">.C:0bb7   85 FB      STA $FB</span><br><span class="line"></span><br><span class="line">.C:0bb9   A9 01      LDA #$01       ; Enable sprite #0</span><br><span class="line">.C:0bbb   8D 15 D0   STA $D015</span><br><span class="line"></span><br><span class="line">.C:0bbe   60         RTS            ; return</span><br><span class="line"></span><br><span class="line">                                    ; sprite data</span><br><span class="line">                                    </span><br><span class="line">&gt;C:0bbf  70 00 04 d0  00 04 80 00   p.......</span><br><span class="line">&gt;C:0bc7  26 e5 76 54  37 45 74 64   &amp;.vT7Etd</span><br><span class="line">&gt;C:0bcf  64 44 c2 30  22 10 01 00   dD.0&quot;...</span><br><span class="line">&gt;C:0bd7  10 01 00 7c  07 c0 38 03   ...|..8.</span><br><span class="line">&gt;C:0bdf  80 10 01 00  00 00 00 e1   ........</span><br><span class="line">&gt;C:0be7  22 e2 93 36  b5 92 be 95   &quot;..6....</span><br><span class="line">&gt;C:0bef  e2 aa b5 a2  a2 e5 a7 a2   ........</span><br><span class="line">&gt;C:0bf7  b5 94 a2 95  94 a2 f2 00   ........</span><br></pre></td></tr></table></figure>
<h3 id="Varazslat"><a href="#Varazslat" class="headerlink" title="Varázslat"></a>Varázslat</h3><p>A feladat kiírásában szerepelt az is, hogy lehet írni egy aprócska basic programot a basic indító és a gépikód közé, amivel varázslatos dolgokat lehet művelni az alsó sorban kavaró sprite-tal:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">1a$=&quot;78:200;=17109=&lt;;09&gt;8&gt;005=0?5:9078=?;09584&lt;4&gt;104&lt;1:10:032&lt;&lt;12=0=0?;:00988=&quot;</span><br><span class="line">2b$=&quot;0?=:=16=0:&gt;?;098&gt;16=0:03:&lt;&lt;12=0=0?;:00:88=0?=8=16=0&lt;:8&gt;?;09&gt;000=005:2074&lt;&quot;</span><br><span class="line">3c$=&quot;=809410&quot;:k=4096</span><br><span class="line">4d$=a$+b$+c$:fOi=0to105:a=16*(aS(mI(d$,1+2*i,1))-48)+(aS(mI(d$,2*i+2,1))-48)</span><br><span class="line">5pOi+k,a:nE:sYk</span><br></pre></td></tr></table></figure>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2017 <a href="/" rel="nofollow">Caiwan</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>