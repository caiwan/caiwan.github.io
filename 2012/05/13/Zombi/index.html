<!DOCTYPE html><html><head><meta http-equiv="content-type" content="text/html; charset=utf-8"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black-translucent" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="description" content="Bővített kiadás"><title>Zombiföldről - visszafejtve | Caiwan Blogja</title><link rel="stylesheet" type="text/css" href="/css/normalize.css"><link rel="stylesheet" type="text/css" href="/css/highlight.css"><link rel="stylesheet" type="text/css" href="/css/very-simple.css"><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/font-awesome/4.5.0/css/font-awesome.min.css"><link rel="Shortcut Icon" type="image/x-icon" href="/favicon.ico"></head><body><!-- include the sidebar--><!-- include ./includes/sidebar.jade--><!-- Blog title and subtitle--><header><div class="container header"><a id="logo" href="/." class="title">Caiwan Blogja</a><span class="subtitle">Farkaska kalajdnai az IT világában. Ugyanitt kedvezményes grafikus képzés.</span><label id="toggle-menu" for="menu" onclick><i class="fa fa-bars"></i></label></div></header><!-- use checkbox hack for toggle nav-bar on small screens--><input id="menu" type="checkbox"><!-- Navigation Links--><nav id="nav"><div class="container"><a href="/" class="sidebar-nav-item active">Home</a><a href="/archives" class="sidebar-nav-item">Archives</a></div></nav><div id="header-margin-bar"></div><!-- gallery that comes before the header--><div class="wrapper"><div class="container post-header"><h1>Zombiföldről - visszafejtve</h1></div></div><div class="wrapper"><div class="container meta"><div class="post-time">2012-05-13</div><div class="post-categories"><a class="post-category-link" href="/categories/prog/">prog</a></div><div class="post-tags"><a class="post-tag-link" href="/tags/assembly/">assembly</a>/<a class="post-tag-link" href="/tags/bme/">bme</a>/<a class="post-tag-link" href="/tags/c64/">c64</a>/<a class="post-tag-link" href="/tags/disassembly/">disassembly</a></div></div></div><article><div class="container post"><p>Egy ismerősömtől kaptam egy levelet, hogy segítsek egy BME-VIK gólyatábor feladat megoldásában, mivel korábban többször foglalkoztam Commodore 64 programozással, és érdekelt, hogy a VIK-es kollégák milyen programot írtak C64-re, ezért teljesen visszafejtettem a kiadott programot.</p>
<p>A történet szerint zombik ellen kell harcolnunk, és szükségrogünk van egy titkos kódra.  A  program a képernyő felső sorába egy scroller van, amiben a küldetés  feladatait sorolja, alsó sorban pedig egy sprite, amin a titkos kód  található, amit a keret eltakar. Ránézésre egyszerű kis programocska, de  nézzünk bele, mi is van benne pontosan, és milyen megoldásokat  alkalmaztak.</p>
<p><strike>Forrás: </strike><a href="http://golya.sch.bme.hu/rejtvenyek_zombifoldrol_2____commodore" style="text-decoration: line-through;" target="_blank" rel="external">http://golya.sch.bme.hu/rejtvenyek_zombifoldrol_2____commodore</a> <b>Már nem elérhető az eredeti helyen.</b></p>
<h2 id="Kezdo-lepesek"><a href="#Kezdo-lepesek" class="headerlink" title="Kezdő lépések"></a>Kezdő lépések</h2><p>Akkor lássunk is neki, ezúttal modern eszközök felhasználásával. A boncoláshoz a Vice monitorját használom fel, illetve az ICU64 nevű progit, ami láthatóvá teszi valós időben a gép memóriáját. </p>
<p>Először illene tudni, hogy a program a memória melyik területén helyezkedik majd el, a betöltést követően. Ezt nem nehéz megmondani. Minden C64 futtatható bináris első két byteja a kezdőcímet tartalmazza, ahova betölti a lemezről Kernal (nem <em>kernel</em> ) a kódot. Mivel programunk a <code>RUN</code> parancsra le is fut, ezért ennek a címnek a basic terület elejére kell hogy mutasson, ami a <code>$0800</code> = 2048 (továbbiakban <code>$xxxx</code> formátumban írom le) címtől kezdődik. Ha ezen a címen <code>$00</code> van, akkor a Kernal az ezt követő kódot basic kódként fogja kezelni, tehát a fileunk a <code>$0801</code> címtől kell hogy betöltődjön, de azért nézzünk bele egy HEX editorral:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div></pre></td><td class="code"><pre><div class="line">0000: 01 08</div></pre></td></tr></table></figure>
<p>így is van. A fileunkból ez a két byte “kiesik” így a 2048 byteos hossz 2046-ra (<code>$03FE</code>) csökken. A kezdőcímből és a hosszból tudjuk, hogy a kódunk <code>$0801</code> és <code>$0BFF</code> között lesz (A továbbiakban a listázást mégis <code>$0800</code>-ról kezdem majd)</p>
<p>Minden program, amit <code>RUN</code> paranccsal szeretnénk futtatni, annak a basic tárterület elejétől a basic interpreter által értelmezhető basic kódnak kell lennie. Még akkor is, ha a basicben egyetlen <code>SYS</code> parancs található, amivel a megadott címtől kezdődő gépi kód hajtódik végre. Ebből következik, hogy a <code>LIST</code> parancs kiadására, látni kellene valamilyen basic kódot.</p>
<div class="separator" style="clear: both; text-align: center;"><br><a href="http://4.bp.blogspot.com/-voW38pa27TM/Tjv7jOkNB8I/AAAAAAAABiU/Zdtp9swcRv4/s1600/Clipboard-4.jpg" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" target="_blank" rel="external"><img border="0" height="283" src="http://4.bp.blogspot.com/-voW38pa27TM/Tjv7jOkNB8I/AAAAAAAABiU/Zdtp9swcRv4/s400/Clipboard-4.jpg" width="400"></a></div>

<p>Hopp, nem így történt. VIK-es kollégáink valamilyen listázás elleni védelmet alkalmaztak, vagy azért hogy jobban nézzen ki a lista, vagy azért, hogy elrejtsék a gépi kód kezdőcímét. Akkor nézzünk bele a BASIC ram területbe, mi található ott.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">&gt;C:0800  00 1e 08 00  00 9e 32 34   ......24</div><div class="line">&gt;C:0808  37 34 3a 8f  22 8d 91 2d   74:.&quot;..-</div><div class="line">&gt;C:0810  42 4d 45 2d  56 49 4b 20   BME-VIK</div><div class="line">&gt;C:0818  32 30 31 31  2d 00 00 00   2011-...</div></pre></td></tr></table></figure>
<p>Nos, lássuk hogy is kell mindezt értelmezni, ezúttal $0800-tól:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">0800: 00           Basic fejléc</div><div class="line">0801: 1e 08        Következo sor kezdocíme (link)</div><div class="line">0803: 00 00        Sorszám (16 biten)</div><div class="line">0805: 9e           Basic token</div><div class="line">0806: 32 34 37 34  Basic utasítás argumentumai (ascii-ba)  </div><div class="line">080a: 3a           A basic utasításokat elválasztó kettospont </div><div class="line">080b: 8f           Következo basic token </div><div class="line">080c: 22 8d 91 ... Argumentumok </div><div class="line">081d: 00           Sor vége </div><div class="line">081e: 00 00        Következo sor kezdocíme</div></pre></td></tr></table></figure>
<p>Vegyük szépen sorba. A sorok egy láncolt listához hasonló (de nem teljesen az, mert köztes sor beszúrásakor átrendezi) struktúrában foglalnak helyet; illetve csak listázáskor használja az interpreter.  A linket követően a sorszám, majd a sor tartalma. Minden sor végét egy nulla jelöl. Minden basic utasítást rövidít le.</p>
<p>Ezek alapján a basic sorunk valahogy így fest:</p>
<div class="separator" style="clear: both; text-align: center;"><br><a href="http://4.bp.blogspot.com/-XDxIB_M10jM/T6LEcyXpmuI/AAAAAAAAB8Y/6pEOQ2xhUPs/s1600/Clipboard-3.png" imageanchor="1" style="margin-left: 1em; margin-right: 1em;" target="_blank" rel="external"><img border="0" height="15" src="http://4.bp.blogspot.com/-XDxIB_M10jM/T6LEcyXpmuI/AAAAAAAAB8Y/6pEOQ2xhUPs/s640/Clipboard-3.png" width="640"></a></div>

<p>Itt látható már, hogy a basic kódba a megjegyzés utasítást (REM) követő három karakter felel a “védelemért”, az inverz M és Q két vezérlőkarakter (CBM karaktertábla szerint). Ezek a vezérlő karakterek ún. idézőjel-módba karakterláncként építhetők be a kódba, későbbi felhasználás (print) végett. Ha ebből a módból sikerül “megszökni”, akkor a list parancs kírás közbe “végrehajtja” ezeket. Az inverz M sortörést produkál, az inverz Q pedig egy kurzor fel, így a <code>-BME-VIK-2011-</code> karaktersor felülírja listázáskor az előzőleg kiírt <code>0 sys2474:REM&quot;</code> részt.</p>
<p>Ezután már a kezdőcímet követve végig kell menni egy disassemberrel a memóraképen. Vice-ban van beépített monitor, ami képes mindenféle mellékhatás nélkül a memóriába látni.</p>
<h3 id="Teljes-disassembly"><a href="#Teljes-disassembly" class="headerlink" title="Teljes disassembly"></a>Teljes disassembly</h3><p>Végül itt a teljes disassemblelt kód:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div></pre></td><td class="code"><pre><div class="line">; BME-VIK gólyafeladat</div><div class="line">; FULL DISASSEMBLY</div><div class="line"></div><div class="line">                                    ; BASIC LOADER</div><div class="line"></div><div class="line">&gt;C:0800  00 1e 08 00  00 9e 32 34   ......24</div><div class="line">&gt;C:0808  37 34 3a 8f  22 8d 91 2d   74:.&quot;..-</div><div class="line">&gt;C:0810  42 4d 45 2d  56 49 4b 20   BME-VIK</div><div class="line">&gt;C:0818  32 30 31 31  2d 00 00 00   2011-...</div><div class="line"></div><div class="line">                                    ; entry point (2474 = $09aa)</div><div class="line">                                    ; MAIN</div><div class="line">                                    </div><div class="line">.C:09aa   20 63 0B   JSR $0B63      ; call subroutine 1</div><div class="line">.C:09ad   20 FD 0A   JSR $0AFD      ; call subroutine 2</div><div class="line">.C:09b0   60         RTS            ; return (to basic)</div><div class="line"></div><div class="line">                                    ; IRQ routine</div><div class="line">                                    </div><div class="line">.C:09b1   20 C2 09   JSR $09C2      ; call scroller subroutine </div><div class="line"></div><div class="line">.C:09b4   EE 00 D0   INC $D000      ; increase sprite #0 X coord (#bit 0-7)</div><div class="line">.C:09b7   D0 03      BNE $09BC      ; branch while overflow occurs via INC</div><div class="line">.C:09b9   EE 10 D0   INC $D010      ; increase sprite #bit 8</div><div class="line"></div><div class="line">.C:09bc   0E 19 D0   ASL $D019      ; acknowledge raster IRQ</div><div class="line">.C:09bf   4C 31 EA   JMP $EA31      ; jump back to kernal</div><div class="line"></div><div class="line">                                    ; scroller</div><div class="line">                                    </div><div class="line">.C:09c2   8D F5 09   STA $09F5      ; push X, Y regs and A to local vars (@ line $09f4)</div><div class="line">.C:09c5   8E F7 09   STX $09F7    </div><div class="line">.C:09c8   8C F9 09   STY $09F9      </div><div class="line"></div><div class="line">.C:09cb   AE FB 09   LDX $09FB      ; inc local var 1 @09FB - delay</div><div class="line">.C:09ce   E8         INX</div><div class="line">.C:09cf   8E FB 09   STX $09FB</div><div class="line">.C:09d2   E0 08      CPX #$08        </div><div class="line">.C:09d4   D0 1E      BNE $09F4      ; if (X != 8) branch</div><div class="line"></div><div class="line">.C:09d6   A2 00      LDX #$00</div><div class="line">.C:09d8   8E FB 09   STX $09FB      ; local var 1</div><div class="line">.C:09db   A0 00      LDY #$00</div><div class="line">.C:09dd   AE FC 09   LDX $09FC      ; local var 2 - text pointer</div><div class="line">.C:09e0   BD FD 09   LDA $09FD,X    ; text data</div><div class="line">.C:09e3   E8         INX</div><div class="line">.C:09e4   99 00 04   STA $0400,Y    ; copy to screen</div><div class="line">.C:09e7   A9 01      LDA #$01       ; fill color memory</div><div class="line">.C:09e9   99 00 D8   STA $D800,Y    </div><div class="line">.C:09ec   C8         INY</div><div class="line">.C:09ed   C0 28      CPY #$28</div><div class="line">.C:09ef   D0 EF      BNE $09E0      ; loop while (y != 40)</div><div class="line">.C:09f1   EE FC 09   INC $09FC      ; inc text pointer</div><div class="line"></div><div class="line">.C:09f4   A9 00      LDA #$00       ; pop X, Y regs and A from local vars (set @ line $09c2)</div><div class="line">.C:09f6   A2 00      LDX #$00</div><div class="line">.C:09f8   A0 00      LDY #$00</div><div class="line"></div><div class="line">.C:09fa   60         RTS            ; return</div><div class="line"></div><div class="line">                                    ; local vars ($09fb-$09fc) + scroller text</div><div class="line">&gt;C:09fb  00 00 20 20  20 20 20 20   ..        ;   &quot;      &quot;</div><div class="line">&gt;C:0a03  20 20 20 20  20 20 20 20             ; &quot;        &quot;</div><div class="line">&gt;C:0a0b  20 20 20 20  20 20 20 20             ; &quot;        &quot;</div><div class="line">&gt;C:0a13  20 20 20 20  20 20 20 20             ; &quot;        &quot;</div><div class="line">&gt;C:0a1b  20 20 20 20  20 20 20 20             ; &quot;        &quot;</div><div class="line">&gt;C:0a23  20 20 01 0e  14 09 2d 1a     ....-.  ; &quot;  ANTI-Z&quot;</div><div class="line">&gt;C:0a2b  0f 0d 02 09  05 20 02 15   ..... ..  ; &quot;OMBIE BU&quot;</div><div class="line">&gt;C:0a33  0e 0b 05 12  20 03 0f 0d   .... ...  ; &quot;NKER COM&quot;</div><div class="line">&gt;C:0a3b  0d 01 0e 04  20 01 13 13   .... ...  ; &quot;MAND ASS&quot;</div><div class="line">&gt;C:0a43  09 07 0e 0d  05 0e 14 3a   .......:  ; &quot;IGNMENT:&quot;</div><div class="line">&gt;C:0a4b  20 20 20 31  2e 20 05 12      1. ..  ; &quot;   1. ER&quot;</div><div class="line">&gt;C:0a53  01 04 09 03  01 14 05 20   .......   ; &quot;DANCIATE&quot;</div><div class="line">&gt;C:0a5b  01 0e 19 20  01 0e 04 20   ... ...   ; &quot;ANY AND &quot;</div><div class="line">&gt;C:0a63  01 0c 0c 20  08 0f 13 14   ... ....  ; &quot;ALL HOST&quot;</div><div class="line">&gt;C:0a6b  09 0c 05 20  06 0f 12 03   ... ....  ; &quot;ILE FORC&quot;</div><div class="line">&gt;C:0a73  05 13 2e 20  20 32 2e 20   ...  2.   ; &quot;ES.  2. &quot;</div><div class="line">&gt;C:0a7b  12 05 03 0f  16 05 12 20   .......   ; &quot;RECOVER &quot;</div><div class="line">&gt;C:0a83  01 0c 0c 20  01 16 01 09   ... ....  ; &quot;ALL AVAI&quot;</div><div class="line">&gt;C:0a8b  0c 01 02 0c  05 20 13 15   ..... ..  ; &quot;LABLE SU&quot;</div><div class="line">&gt;C:0a93  10 10 0c 09  05 13 2e 20   .......   ; &quot;PPLIES. &quot;</div><div class="line">&gt;C:0a9b  20 20 33 2e  20 03 0f 0d     3. ...  ; &quot;  3. COM&quot;</div><div class="line">&gt;C:0aa3  10 0c 05 14  05 20 13 05   ..... ..  ; &quot;PLETE SE&quot;</div><div class="line">&gt;C:0aab  03 12 05 14  20 0d 09 13   .... ...  ; &quot;CRET MIS&quot;</div><div class="line">&gt;C:0ab3  13 09 0f 0e  2e 20 20 34   .....  4  ; &quot;SION.  4&quot;</div><div class="line">&gt;C:0abb  2e 20 13 14  01 19 20 01   . .... .  ; &quot;. STAY A&quot;</div><div class="line">&gt;C:0ac3  0c 09 16 05  2c 20 12 05   ...., ..  ; &quot;LIVE, RE&quot;</div><div class="line">&gt;C:0acb  10 0f 12 14  20 02 01 03   .... ...  ; &quot;PORT BAC&quot;</div><div class="line">&gt;C:0ad3  0b 20 14 0f  20 02 01 13   . .. ...  ; &quot;K TO BAS&quot;</div><div class="line">&gt;C:0adb  05 20 01 0e  04 20 04 0f   . ... ..  ; &quot;E AND DO&quot;</div><div class="line">&gt;C:0ae3  0e 27 14 20  07 05 14 20   .&apos;. ...   ; &quot;N&apos;T GET &quot;</div><div class="line">&gt;C:0aeb  08 15 12 14  21 20 20 20   ....!     ; &quot;HURT!   &quot;</div><div class="line">&gt;C:0af3  07 0f 0f 04  20 0c 15 03   .... ...  ; &quot;GOOD LUC&quot;</div><div class="line">&gt;C:0afb  0b 21                      .!        ; &quot;K!&quot;</div><div class="line"></div><div class="line">                                    ; SUBROUTINE 2</div><div class="line">                                    ; interruption setup</div><div class="line">                                    </div><div class="line">.C:0afd   78         SEI            ; set interrupt bit</div><div class="line"></div><div class="line">.C:0afe   A9 7F      LDA #$7F       ; Set interrupt controls</div><div class="line">.C:0b00   8D 0D DC   STA $DC0D      ; Set IRQ </div><div class="line">.C:0b03   8D 0D DD   STA $DD0D      ; Set NMI (WTF)</div><div class="line">.C:0b06   AD 1A D0   LDA $D01A      ; Enable raster interruption</div><div class="line">.C:0b09   09 01      ORA #$01       ; bitmask 000001</div><div class="line">.C:0b0b   8D 1A D0   STA $D01A      </div><div class="line">.C:0b0e   AD 11 D0   LDA $D011      ; Rasterline to generate interruption</div><div class="line">.C:0b11   29 7F      AND #$7F       ; bitmask %01111111</div><div class="line">.C:0b13   8D 11 D0   STA $D011      </div><div class="line">.C:0b16   A9 01      LDA #$01       ; Set the interruption on raster line $01</div><div class="line">.C:0b18   8D 12 D0   STA $D012</div><div class="line">.C:0b1b   A9 B1      LDA #$B1       ; Set IRQ vector (lo)</div><div class="line">.C:0b1d   8D 14 03   STA $0314</div><div class="line">.C:0b20   A9 09      LDA #$09       ; (hi)</div><div class="line">.C:0b22   8D 15 03   STA $0315      ; IRQ at $09B1</div><div class="line"></div><div class="line">.C:0b25   58         CLI            ; clear interrupt bit</div><div class="line">.C:0b26   60         RTS            ; return</div><div class="line"></div><div class="line">                                    ; SUBROUTINE 3 - memcpy</div><div class="line"></div><div class="line">.C:0b27   8C 44 0B   STY $0B44      ; set comparison val @ line $0b43 to Y reg.</div><div class="line"></div><div class="line">.C:0b2a   A0 00      LDY #$00       ; clear Y</div><div class="line">.C:0b2c   E0 00      CPX #$00</div><div class="line">.C:0b2e   F0 0E      BEQ $0B3E      ; if (X == 0) branch</div><div class="line"></div><div class="line">.C:0b30   B1 FB      LDA ($FB),Y    ; copy ($FB)+y to ($FD)+y</div><div class="line">.C:0b32   91 FD      STA ($FD),Y</div><div class="line">.C:0b34   C8         INY            ; inc Y</div><div class="line">.C:0b35   D0 F9      BNE $0B30      ; loop</div><div class="line"></div><div class="line">.C:0b37   E6 FE      INC $FE        ; inc $FE (hi byte of src)</div><div class="line">.C:0b39   E6 FC      INC $FC        ; inc $FC (hi byte of dest)</div><div class="line">.C:0b3b   CA         DEX            ; dec X</div><div class="line">.C:0b3c   D0 F2      BNE $0B30      ; loop while (X != 0)</div><div class="line"></div><div class="line">.C:0b3e   B1 FB      LDA ($FB),Y    ; copy ($FB)+y to ($FD)+y</div><div class="line">.C:0b40   91 FD      STA ($FD),Y</div><div class="line">.C:0b42   C8         INY</div><div class="line"></div><div class="line">.C:0b43   C0 00      CPY #$00       ; compare (were set @ line $0b27)</div><div class="line">.C:0b45   D0 F7      BNE $0B3E      ; loop</div><div class="line"></div><div class="line">.C:0b47   60         RTS            ; return </div><div class="line"></div><div class="line">                                    ; SUBROUTINE 4 - memset</div><div class="line">                                    </div><div class="line">.C:0b48   8C 5F 0B   STY $0B5F      ; set cmp. val @ line $0b5e</div><div class="line"></div><div class="line">.C:0b4b   A0 00      LDY #$00</div><div class="line">.C:0b4d   E0 00      CPX #$00</div><div class="line">.C:0b4f   F0 0A      BEQ $0B5B      ; if (X == 0) branch</div><div class="line"></div><div class="line">.C:0b51   91 FD      STA ($FD),Y    ; set ($FD)+y to ACC</div><div class="line">.C:0b53   C8         INY</div><div class="line">.C:0b54   D0 FB      BNE $0B51      ; loop</div><div class="line"></div><div class="line">.C:0b56   E6 FE      INC $FE        ; inc $FE (hi byte of dst)</div><div class="line">.C:0b58   CA         DEX</div><div class="line">.C:0b59   D0 F6      BNE $0B51      ; loop</div><div class="line"></div><div class="line">.C:0b5b   91 FD      STA ($FD),Y</div><div class="line">.C:0b5d   C8         INY</div><div class="line">.C:0b5e   C0 00      CPY #$00</div><div class="line">.C:0b60   D0 F9      BNE $0B5B      ; loop</div><div class="line"></div><div class="line">.C:0b62   60         RTS            ; return</div><div class="line">        </div><div class="line">                                    ; SUBROUTINE 1 </div><div class="line"></div><div class="line">.C:0b63   A9 01      LDA #$01       ; set sprite #0 X-coord #bit 8</div><div class="line">.C:0b65   8D 10 D0   STA $D010</div><div class="line"></div><div class="line">.C:0b68   A9 00      LDA #$00</div><div class="line">.C:0b6a   8D 17 D0   STA $D017      ; reset sprite double height bits</div><div class="line">.C:0b6d   8D 1B D0   STA $D01B      ; reset sprite priority bits </div><div class="line">.C:0b70   8D 1C D0   STA $D01C      ; reset sprite multicolor bits</div><div class="line">.C:0b73   8D 1D D0   STA $D01D      ; reset sprite double bits</div><div class="line"></div><div class="line">.C:0b76   A9 60      LDA #$60       ; set sprite #0 X-coord</div><div class="line">.C:0b78   8D 00 D0   STA $D000</div><div class="line">.C:0b7b   A9 EE      LDA #$EE       ; set sprite #0 Y-coord</div><div class="line">.C:0b7d   8D 01 D0   STA $D001</div><div class="line"></div><div class="line">.C:0b80   A9 01      LDA #$01       ; set sprite #0 color</div><div class="line">.C:0b82   8D 27 D0   STA $D027        </div><div class="line"></div><div class="line">.C:0b85   A9 FF      LDA #$FF       ; set sprite data pointer</div><div class="line">.C:0b87   8D F8 07   STA $07F8</div><div class="line"></div><div class="line">.C:0b8a   A5 FB      LDA $FB        ; push zero page to stack</div><div class="line">.C:0b8c   48         PHA</div><div class="line">.C:0b8d   A5 FC      LDA $FC</div><div class="line">.C:0b8f   48         PHA</div><div class="line">.C:0b90   A5 FD      LDA $FD</div><div class="line">.C:0b92   48         PHA</div><div class="line">.C:0b93   A5 FE      LDA $FE</div><div class="line">.C:0b95   48         PHA</div><div class="line"></div><div class="line">.C:0b96   A9 BF      LDA #$BF       ; copy source (lo)</div><div class="line">.C:0b98   85 FB      STA $FB</div><div class="line">.C:0b9a   A9 0B      LDA #$0B       ; copy source (hi) - sprite data $0bbf</div><div class="line">.C:0b9c   85 FC      STA $FC</div><div class="line">.C:0b9e   A9 C0      LDA #$C0       ; copy dest. (lo)</div><div class="line">.C:0ba0   85 FD      STA $FD</div><div class="line">.C:0ba2   A9 3F      LDA #$3F       ; copy dest. (hi) - sprite data $3fc0 </div><div class="line">.C:0ba4   85 FE      STA $FE</div><div class="line">.C:0ba6   A4 3F      LDY $3F        ; legth (lo)</div><div class="line">.C:0ba8   A6 40      LDX $40        ; legth (hi)</div><div class="line">.C:0baa   20 27 0B   JSR $0B27      ; call subroutine 3</div><div class="line"></div><div class="line">.C:0bad   68         PLA            ; pop zero page from stack</div><div class="line">.C:0bae   85 FE      STA $FE</div><div class="line">.C:0bb0   68         PLA</div><div class="line">.C:0bb1   85 FD      STA $FD</div><div class="line">.C:0bb3   68         PLA</div><div class="line">.C:0bb4   85 FC      STA $FC</div><div class="line">.C:0bb6   68         PLA</div><div class="line">.C:0bb7   85 FB      STA $FB</div><div class="line"></div><div class="line">.C:0bb9   A9 01      LDA #$01       ; Enable sprite #0</div><div class="line">.C:0bbb   8D 15 D0   STA $D015</div><div class="line"></div><div class="line">.C:0bbe   60         RTS            ; return</div><div class="line"></div><div class="line">                                    ; sprite data</div><div class="line">                                    </div><div class="line">&gt;C:0bbf  70 00 04 d0  00 04 80 00   p.......</div><div class="line">&gt;C:0bc7  26 e5 76 54  37 45 74 64   &amp;.vT7Etd</div><div class="line">&gt;C:0bcf  64 44 c2 30  22 10 01 00   dD.0&quot;...</div><div class="line">&gt;C:0bd7  10 01 00 7c  07 c0 38 03   ...|..8.</div><div class="line">&gt;C:0bdf  80 10 01 00  00 00 00 e1   ........</div><div class="line">&gt;C:0be7  22 e2 93 36  b5 92 be 95   &quot;..6....</div><div class="line">&gt;C:0bef  e2 aa b5 a2  a2 e5 a7 a2   ........</div><div class="line">&gt;C:0bf7  b5 94 a2 95  94 a2 f2 00   ........</div></pre></td></tr></table></figure>
<h3 id="Varazslat"><a href="#Varazslat" class="headerlink" title="Varázslat"></a>Varázslat</h3><p>A feladat kiírásában szerepelt az is, hogy lehet írni egy aprócska basic programot a basic indító és a gépikód közé, amivel varázslatos dolgokat lehet művelni az alsó sorban kavaró sprite-tal:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div></pre></td><td class="code"><pre><div class="line">1a$=&quot;78:200;=17109=&lt;;09&gt;8&gt;005=0?5:9078=?;09584&lt;4&gt;104&lt;1:10:032&lt;&lt;12=0=0?;:00988=&quot;</div><div class="line">2b$=&quot;0?=:=16=0:&gt;?;098&gt;16=0:03:&lt;&lt;12=0=0?;:00:88=0?=8=16=0&lt;:8&gt;?;09&gt;000=005:2074&lt;&quot;</div><div class="line">3c$=&quot;=809410&quot;:k=4096</div><div class="line">4d$=a$+b$+c$:fOi=0to105:a=16*(aS(mI(d$,1+2*i,1))-48)+(aS(mI(d$,2*i+2,1))-48)</div><div class="line">5pOi+k,a:nE:sYk</div></pre></td></tr></table></figure>
</div><!-- comment system--><div class="container"><hr></div></article><footer id="footer"><div class="container"><div class="bar"><div class="social"><a href="/atom.xml" target="_blank"><i class="fa fa-rss"></i></a></div><div class="footer">© 2018 <a href="/" rel="nofollow">Caiwan</a>. Powered by <a rel="nofollow" target="_blank" href="https://hexo.io">Hexo</a>. Theme <a target="_blank" href="https://github.com/lotabout/very-simple">very-simple</a>.</div></div></div></footer><link rel="stylesheet" type="text/css" href="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.css"><script src="//cdn.bootcss.com/jquery/2.0.3/jquery.min.js"></script><script src="//cdn.bootcss.com/fancybox/2.1.5/jquery.fancybox.pack.js"></script><script>$(document).ready(function() {
    $(".fancybox").fancybox();
});
</script></body></html>